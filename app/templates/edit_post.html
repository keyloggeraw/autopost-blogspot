{% extends "base.html" %}
{% block title %}Edit Postingan{% endblock %}

{% block head %}
<script src="https://cdn.tiny.cloud/1/n8fje94p2tawq9nzxjmad153rawj69b5vrtuwqrq72nrqwtb/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
<!-- Tagify -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify/dist/tagify.css">
<script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<style>
.ck-editor__editable[role="textbox"] { min-height: 500px; height: 600px !important; max-height: 800px; font-size: 1.1rem; }
.ck-editor__main { max-width: 1200px; }
.tagify { width: 100% !important; min-width: 250px !important; max-width: 100% !important; font-size: 1.1rem; }
#labels-list span { background:#f2f2f2; border:1px solid #eee; display:inline-block; padding:3px 10px; margin:2px; border-radius:15px; }
@media (max-width: 991px) {
  .right-panel { margin-top:2rem; }
}
</style>
{% endblock %}

{% block content %}
<h2 class="mb-4"><i class="bi bi-pencil-square me-2"></i>Edit Postingan</h2>

<form method="POST" autocomplete="off">
  <div class="row">
    <!-- KIRI: KONTEN UTAMA -->
    <div class="col-lg-8">
      <!-- PILIH BLOG -->
      <div class="mb-3">
        <label for="blogspot_blog_id" class="form-label fw-semibold">
          <i class="bi bi-globe me-1"></i> Pilih Blog
        </label>
        <select name="blogspot_blog_id" class="form-select" required>
          {% for blog in blogs %}
            <option value="{{ blog.id }}" {% if blog.id == post.blogspot_blog_id %}selected{% endif %}>
              {{ blog.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <!-- JUDUL -->
      <div class="mb-3">
        <label for="title" class="form-label fw-semibold">
          <i class="bi bi-type me-1"></i> Judul
        </label>
        <input type="text" name="title" class="form-control" value="{{ post.title|e }}" required>
      </div>
      <!-- CKEDITOR -->
      <div class="mb-3">
        <label for="content" class="form-label fw-semibold">
          <i class="bi bi-file-earmark-richtext me-1"></i> Isi Artikel
        </label>
        <textarea name="content" id="ckeditor" class="form-control"
            rows="20"
            style="min-height:500px; height:600px; width:100%; max-width:1200px;"
        >{{ post.content|e }}</textarea>
      </div>
    </div>
    <!-- KANAN: INFO & TOOLS -->
    <div class="col-lg-4 right-panel">
      <!-- DAFTAR LABEL TERSEDIA -->
      <div class="mb-4">
        <label class="form-label fw-semibold">
          <i class="bi bi-tags me-1"></i> Daftar Label Tersedia:
        </label>
        <div id="labels-list" class="mb-2" style="min-height:30px; font-size:15px; color:#444;"></div>
      </div>
      <!-- TAGIFY LABEL INPUT -->
      <div class="mb-4">
        <label for="labels" class="form-label fw-semibold">
          <i class="bi bi-tag me-1"></i> Label
        </label>
        <input
            name="labels"
            id="labels"
            placeholder="Ketik label, pisahkan koma/enter..."
            value='{{ labels|tojson|safe }}'
            class="form-control"
            autofocus
        >
        <small class="text-muted">Pisahkan label dengan koma atau tekan Enter. Bisa pilih dari saran atau ketik label baru.</small>
      </div>
      <!-- SEARCH DESCRIPTION -->
      <div class="mb-4">
        <label for="search_description" class="form-label fw-semibold">
          <i class="bi bi-search me-1"></i> Search Description
        </label>
        <input type="text" name="search_description" class="form-control"
               maxlength="150" value="{{ post.search_description|default('', true) }}">
      </div>
      <!-- JADWAL -->
      <div class="mb-4">
        <label for="scheduled_time" class="form-label fw-semibold">
          <i class="bi bi-calendar2-week me-1"></i> Jadwalkan Tanggal & Jam
        </label>
        <input type="datetime-local" name="scheduled_time" class="form-control"
            value="{{ post.scheduled_time.strftime('%Y-%m-%dT%H:%M') if post.scheduled_time else '' }}" required>
      </div>
      <!-- TOMBOL -->
      <div class="d-flex gap-2 mt-3">
        <button type="submit" class="btn btn-primary flex-fill">
          <i class="bi bi-arrow-repeat me-1"></i> Update Postingan
        </button>
        <a href="{{ url_for('routes.list_posts') }}" class="btn btn-outline-secondary flex-fill">
          <i class="bi bi-arrow-left me-1"></i> Batal
        </a>
      </div>
    </div>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  tinymce.init({
    selector: '#ckeditor',
    height: 600,
    plugins: 'code image link lists media table',
    toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | bullist numlist | link image media table | code',
    menubar: false,
    branding: false,
    content_style: "body { font-size:1.1rem; }",
    images_upload_url: '/upload_image',
    automatic_uploads: true,
    file_picker_types: 'image',
    images_reuse_filename: true,
    file_picker_callback: function (cb, value, meta) {
      if (meta.filetype === 'image') {
        var input = document.createElement('input');
        input.setAttribute('type', 'file');
        input.setAttribute('accept', 'image/*');
        input.onchange = function () {
          var file = this.files[0];
          var reader = new FileReader();
          reader.onload = function () {
            var id = 'blobid' + (new Date()).getTime();
            var blobCache = tinymce.activeEditor.editorUpload.blobCache;
            var base64 = reader.result.split(',')[1];
            var blobInfo = blobCache.create(id, file, reader.result);
            blobCache.add(blobInfo);
            cb(blobInfo.blobUri(), { title: file.name });
          };
          reader.readAsDataURL(file);
        };
        input.click();
      }
    }
  });

  // Tagify
  var input = document.querySelector('input[name=labels]');
  var tagify = new Tagify(input, {
    whitelist: [],
    dropdown: {
      enabled: 1,
      maxItems: 100,
      classname: "labels-suggestions",
      fuzzySearch: true,
      highlightFirst: true,
      position: 'auto'
    }
  });

  // Isi Tagify dengan label dari value (list)
  {% if labels %}
  tagify.addTags({{ labels|tojson|safe }});
  {% endif %}

  // Daftar label
  var labelsListDiv = document.getElementById('labels-list');
  function renderLabelsList(labels){
    if (!labelsListDiv) return;
    if (!labels || labels.length === 0) {
      labelsListDiv.innerHTML = "<i>Tidak ada label di blog ini</i>";
    } else {
      labelsListDiv.innerHTML = labels.map(lbl =>
        `<span>${lbl}</span>`
      ).join(' ');
    }
  }
  function loadLabels(){
    var blogSelect = document.querySelector('select[name="blogspot_blog_id"]');
    if(!blogSelect) return;
    var blogId = blogSelect.value;
    fetch('/blogspot_labels/' + blogId)
      .then(r=>r.json())
      .then(labels=>{
        tagify.settings.whitelist = labels;
        renderLabelsList(labels);
      });
  }
  loadLabels();
  var blogSelect = document.querySelector('select[name="blogspot_blog_id"]');
  if(blogSelect){
    blogSelect.addEventListener('change', function(){
      tagify.removeAllTags();
      loadLabels();
    });
  }
});
</script>
{% endblock %}
